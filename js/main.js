let queryParams,Ref,User={user_id:0,name:"",photo:"",access_token:""},Users={},Top=[],Market=[],Card={},currentPage="profile",isExchange=!1,isFriends=!1,isMastersPage=!1,DIFFICULTY_HASH=4;const FADE_SPEED=100;let Popup={close:function(){return $(".popup").fadeOut(FADE_SPEED),$(".popup-back").fadeOut(FADE_SPEED),!1},show:function(e,t=!1,s="",a=!1){this.setText(e,s,a);let n=$(".popup");return n.removeClass("popup-error"),t&&n.addClass("popup-error"),n.fadeIn(FADE_SPEED),$(".popup-back").fadeIn(FADE_SPEED),!1},setText:function(e,t="",s=!1){return s?($(".popup-text").html(e),$(".popup-text-small").html(t)):($(".popup-text").text(e),$(".popup-text-small").html(t)),!1}},bridge=vkBridge;function iPhoneDesignFixes(){/iPhone|iPod/.test(navigator.platform)&&($(".header").css("margin-top","50px"),$(".menu").css("margin-bottom","20px"),$("body").append("<div style='background:#fff;position:fixed;top:0;width:100%;height:50px;z-index:3;'></div>"));let e=/iPhone/.test(navigator.userAgent)&&!window.MSStream,t=window.screen.width/window.screen.height;e&&"0.462"===t.toFixed(3)&&$("body").append("<div style='background:#fff;position:fixed;bottom:0;width:100%;height:30px;z-index:3;'></div>")}function loadProfile(){$(".app_title").text("Я твой раб"),$(".buyDonate").show(),$(".statBtn").hide(),apiCall("game.start",{ref:Ref},function(e){if(updateBalance(e.balance),$(".inviteLink").text(e.ref),$("#slavesCounter").text("Мои рабы ("+e.slaves_count+"):"),$("#buyOut").text("Выкупиться ("+e.buy_out.toLocaleString()+")"),$("#slavesIncome").text("+"+e.slaves_per_hour.toLocaleString()+"/час"),console.log(e),User.ref=e.ref,User.balance=e.balance,User.buyOut=e.buy_out,User.shieldTo=e.shield_to,User.shieldCount=e.shield_count,User.isShieldActive=e.is_shield_active,User.slavesCount=e.slaves_count,DIFFICULTY_HASH=e.hash_difficulty,$("#btnShieldActivate").text("Активировать ("+User.shieldCount+")"),$("#shieldTitle").text(User.isShieldActive?"Щит (активен):":"Щит (не активен):"),$("#shieldTimer").text(e.shield_to),e.owner_id>0||e.slaves.length>0){let t=[];e.owner_id>0?(User.owner_id=parseInt(e.owner_id),Users[e.owner_id]||t.push(e.owner_id)):User.owner_id=0,e.slaves.length>0&&(User.slaves=[],User.slaves.push(e.slaves),e.slaves.forEach(function(e){Users[e.user_id]||t.push(e.user_id)})),vkUsersLoad(t,"slaves")}})}function loadStat(){isMastersPage=!1,$(".app_title").text("Рейтинг"),$(".buyDonate").hide(),$(".statBtn").show(),$(".stat-list").html(""),$(".slave-item").remove(),$(".category-btn").removeClass("active"),$("#topSlaves").addClass("active"),Top=[],apiCall("top.users",{},function(e){$(".stat-position").text(null!=e.position?e.position:"Вы не раб"),loadStatUsers(e.users)})}function loadStatMasters(){isMastersPage=!0,$(".app_title").text("Рейтинг"),$(".buyDonate").hide(),$(".statBtn").show(),$(".stat-list").html(""),$(".slave-item").remove(),Top=[],apiCall("top.masters",{},function(e){$(".stat-position").text(null!=e.position?e.position:"Вы не боярин"),loadStatUsers(e.masters)})}function loadMarket(){$(".app_title").text("Покупка"),$(".buyDonate").show(),$(".statBtn").hide(),$(".slave-item").remove(),$(".category-btn").removeClass("active"),$("#marketCategory").addClass("active"),$(".market-list").html("").removeClass("friends-list"),$("#marketUpdate").show(),$("#exchangeFilters").hide(),$("#sellYourSlaves").hide(),$("#inviteFriendsBtn").hide(),$("#inviteFriendsCard").hide(),$("#noFriends").hide(),isExchange=!1,isFriends=!1,Market=[],apiCall("market.random",{},function(e){loadMarketUsers(e.users)})}function loadExchange(){$(".app_title").text("Покупка"),$(".buyDonate").show(),$(".statBtn").hide(),$(".slave-item").remove(),$(".market-list").html("").removeClass("friends-list"),$("#marketUpdate").hide(),$("#exchangeFilters").show(),$("#sellYourSlaves").show(),$("#inviteFriendsBtn").hide(),$("#inviteFriendsCard").hide(),$("#noFriends").hide(),isExchange=!0,isFriends=!1,Market=[],apiCall("market.exchange",{},function(e){loadMarketUsers(e.users)})}function loadFriends(){$(".app_title").text("Покупка"),$(".buyDonate").show(),$(".statBtn").hide(),$(".slave-item").remove(),$(".market-list").html("").addClass("friends-list"),$("#marketUpdate").hide(),$("#exchangeFilters").hide(),$("#sellYourSlaves").hide(),$("#inviteFriendsBtn").show(),$("#inviteFriendsCard").show(),$("#noFriends").show(),isExchange=!1,isFriends=!0,Market=[],bridge.send("VKWebAppCallAPIMethod",{method:"friends.getAppUsers",request_id:"friends",params:{v:"5.130",access_token:User.access_token}})}function vkUsersLoad(e,t){bridge.send("VKWebAppCallAPIMethod",{method:"users.get",request_id:t,params:{user_ids:e.join(","),fields:"photo_100",v:"5.130",access_token:User.access_token}})}function loadStatUsers(e){if(e.length>0){let t=[];Top.push(e),e.forEach(function(e){Users[e.user_id]||t.push(e.user_id)}),vkUsersLoad(t,"top")}else $(".stat-list").html('<div class="text-nothing">Никого нет в рейтинге</div>')}function loadMarketUsers(e){if(e.length>0){let t=[];Market.push(e),e.forEach(function(e){Users[e.user_id]||t.push(e.user_id)}),vkUsersLoad(t,"market")}else isFriends||$(".market-list").html('<div class="text-nothing">Никого еще тут нет</div>')}function getDonateLink(){apiCall("game.getDonateLink",{},function(e){window.open(e.link,"_blank")})}function apiCall(e,t={},s){$(".loader-wrap").fadeIn(FADE_SPEED),$.post(API_URL+e+"?"+queryParams+"&v="+API_V,t,function(e){$(".loader-wrap").fadeOut(FADE_SPEED),$(".technical-works").hide(),e.error?(Popup.show(e.error,!0),userCardClose()):s(e.response)},"json").fail(function(){$(".loader-wrap").fadeOut(FADE_SPEED),$(".technical-works").show()})}function sSlaveInfo(e){return`<div class="slave-item slave${e.user_id}" onclick="userCardShow(${e.user_id}, 'slaves');">\n                    <div class="slave-info">\n                        <img src="${Users[e.user_id].photo}" alt="ava" class="avatar-small">\n                        <div class="slave-info-text">\n                            <div class="title${e.is_on_market?"-gray":""}">${Users[e.user_id].name}</div>\n                            <div class="income${e.is_on_market?"-gray":""}">+${e.profit_per_hour.toLocaleString()}/час</div>\n                        </div>\n                    </div>\n                    <div class="slave-operations">\n                        <div class="slave-money">\n                            <div class="${e.is_on_market?"time":"slave-upgrade-icon"}"></div>\n                            <div class="income${e.is_on_market?"-gray":""}">\n                            +${e.is_on_market?e.price_exchange.toLocaleString():getNextProfitPerHour(e.profit_per_hour).toLocaleString()+"/час"}</div>\n                        </div>\n                    </div>\n                </div>`}function sSlaveStatInfo(e,t){return`<div class="slave-item">\n                <div class="slave-info">\n                    <div class="slave-position">${t}</div>\n                    <img src="${Users[e.user_id].photo}" alt="ava" class="avatar-small">\n                    <div class="slave-info-text">\n                        <div class="title">${Users[e.user_id].name}</div>\n                        <div class="income">${e.balance.toLocaleString()}<i class="money-icon money-icon-stat"></i>  ${e.slaves_count} ${declOfNum(e.slaves_count,["раб","раба","рабов"])}</div>\n                    </div>\n                </div>\n            </div>`}function sSlaveMarketInfo(e){return`<div class="slave-item slave${e.user_id}" onclick="userCardShow(${e.user_id});">\n                <div class="slave-info">\n                    <img src="${Users[e.user_id].photo}" alt="ava" class="avatar-small">\n                    <div class="slave-info-text">\n                        <div class="title">${Users[e.user_id].name}</div>\n                        <div class="income">+${isExchange?e.profit_per_hour.toLocaleString():getNextProfitPerHour(e.profit_per_hour).toLocaleString()}/час</div>\n                    </div>\n                </div>\n                <div class="slave-operations">\n                    <div class="slave-money">\n                        <div class="money-icon-big"></div>\n                        <div class="income">${e.price.toLocaleString()}</div>\n                    </div>\n                </div>\n            </div>`}function generateHash(e){let t=!1,s=0,a=Math.round((new Date).getTime()/1e3),n="";for(;!t;)(n=(new Hashes.SHA1).hex(a+":"+e+":"+s)).substring(0,DIFFICULTY_HASH)==="0".repeat(DIFFICULTY_HASH)?t=!0:s++;if(t)return{pow_hash:n,pow:a+":"+e+":"+s}}function declOfNum(e,t){return t[e%10==1&&e%100!=11?0:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?1:2]}function getNextProfitPerHour(e){return Math.round(1.5*e)}function userCardClose(){$(".usercard-back").fadeOut(FADE_SPEED),$(".usercard").fadeOut(FADE_SPEED)}function userCardShow(e,t=""){(Card={}).type=""!==t?t:"market",apiCall("users.get",{user_id:e,type:Card.type},function(t){if(Card.slaves_count=t.user.slaves_count,Card.price=t.user.price,Card.priceExchange=t.user.price_exchange,Card.user_id=t.user.user_id,Card.isOnMarket=t.user.is_on_market,Card.owner_id=t.user.owner_id,"slaves"===Card.type){isExchange=!1,Card.balance=t.user.balance,$("#slaveUpgrade").data("id",Card.user_id),Card.position=t.positions[0].length>0?t.positions[0][0].position:t.positions[1][0].position;let e=[];t.stat.forEach(function(t){e.push([parseInt(t.price),parseInt(t.count)])}),Card.stat=e}Card.profit_per_hour=isExchange?t.user.profit_per_hour:getNextProfitPerHour(t.user.profit_per_hour),Card.profit_per_hour_now=t.user.profit_per_hour,vkUsersLoad([e],"usercard")})}function formatName(e,t){return e.substring(0,1)+". "+t}function updateBalance(e){$("#userBalance").html(e.toLocaleString()+'<i class="money-icon"></i>')}function updateUserHtml(){$(".username").text(User.name).off("click").click(function(){openVK(User.user_id)}),$(".your-avatar").attr("src",User.photo).off("click").click(function(){openVK(User.user_id)})}function btnBuyOut(){let e="buyOut"+User.owner_id;$.when($("#buyOut").text("Выкупаемся")).then(function(){$.when(generateHash(e)).then(function(e){apiCall("users.buyOut",{pow:e.pow,pow_hash:e.pow_hash},function(){updateBalance(User.balance-User.buyOut),$("#owner").fadeOut(FADE_SPEED)})})})}function btnRefresh(){window.location.reload()}function btnShare(){bridge.send("VKWebAppShare",{link:$(".inviteLink").first().text()})}function onInviteClick(){bridge.send("VKWebAppCopyText",{text:$(".inviteLink").first().text()})}function btnTopSlaves(){loadStat(),$(".category-btn").removeClass("active"),$("#topSlaves").addClass("active")}function btnTopMasters(){loadStatMasters(),$(".category-btn").removeClass("active"),$("#topMasters").addClass("active")}function btnStatPosition(){isMastersPage&&(!User.slaves||User.slaves.length<1e3)&&Popup.show("Как стать барином?",!1,"Надо накопить 1000 рабов и быть свободным!")}function btnMarket(){loadMarket(),$(".category-btn").removeClass("active"),$("#marketCategory").addClass("active")}function btnExchange(){loadExchange(),$(".category-btn").removeClass("active"),$("#exchangeCategory").addClass("active")}function btnFriends(){loadFriends(),$(".category-btn").removeClass("active"),$("#friendsCategory").addClass("active")}function btnBuyMaster(){userCardClose(),Popup.show("Как купить боярина?",!1,"Стать боярином! A для этого надо накопить 1000 рабов и быть свободным!")}function btnChangeMenu(e){$(".menu-button").removeClass("menu-button-active"),e.addClass("menu-button-active");let t=e.data("to");if(t!==currentPage)switch(currentPage=t,$(".page").hide(),$("#"+t).show(),currentPage){case"profile":loadProfile();break;case"stat":loadStat();break;case"market":loadMarket()}}function vk_updateUserInfo(e){User.user_id=e.id,User.name=formatName(e.first_name,e.last_name),User.fullname=e.first_name+" "+e.last_name,User.photo=e.photo_100,updateUserHtml()}function vk_requestSlaves(e){e.response.forEach(function(e){Users[e.id]={photo:e.photo_100,name:formatName(e.first_name,e.last_name),fullname:e.first_name+" "+e.last_name}}),User.owner_id&&($("#owner-photo").attr("src",Users[User.owner_id].photo).off("click").click(function(){openVK(User.owner_id)}),$("#owner-name").text(Users[User.owner_id].name).off("click").click(function(){openVK(User.owner_id)}),$("#owner").show()),User.slaves?($("#noSlaves").hide(),$("#slavesHelp").show(),$(".slave-item").remove(),User.slaves[0].forEach(function(e,t){User.slaves[0][t].fullname=Users[e.user_id].fullname,$(".slaves-list").append(sSlaveInfo(e))})):($("#noSlaves").show(),$("#slavesHelp").hide())}function vk_requestTopMarket(e){e.response.forEach(function(e){Users[e.id]={photo:e.photo_100,name:formatName(e.first_name,e.last_name),fullname:e.first_name+" "+e.last_name}}),"market"===e.request_id?Market[0].length>0&&($(".slave-item").remove(),Market[0].forEach(function(e){$(".market-list").append(sSlaveMarketInfo(e))})):Top[0].length>0&&($(".slave-item").remove(),Top[0].forEach(function(e,t){$(".stat-list").append(sSlaveStatInfo(e,t+1))}))}function vk_requestFriends(e){apiCall("users.get",{user_ids:e.response.join(","),type:"friends"},function(e){loadMarketUsers(e.users)})}function vk_requestUsercard(e){$(".usercard").fadeIn(FADE_SPEED),$(".usercard-back").fadeIn(FADE_SPEED);let t=e.response[0];switch($("#userCardAvatar").attr("src",t.photo_100).off("click").click(function(){openVK(t.id)}),$("#userCardName").text(Users[t.id].name).off("click").click(function(){openVK(t.id)}),$("#userCardStatus").text(Card.slaves_count>=1e3&&0==Card.owner_id?"Боярин":"Раб"),$("#userCardProfit").text("+"+Card.profit_per_hour.toLocaleString()+"/чаc"),$("#sellPrice").val(""),$(".friends").hide(),Card.type){case"market":showUserCardMarket(t);break;case"slaves":showUserCardSlaves()}}function vk_requestAreFriends(e){doBuy(e.response[0].sign)}function showUserCardMarket(e){$(".market").show(),$(".slaves").hide(),Card.slaves_count>=1e3&&User.slavesCount<1e3?($(".buy-btn").hide(),$(".master-btn").show()):($(".buy-btn").show().html("Купить ("+(isExchange?Card.priceExchange.toLocaleString():Card.price.toLocaleString())+'<i class="money-icon"></i>)').data("id",e.id),isExchange&&$(".buy-btn").data("type","exchange"),$(".master-btn").hide())}function showUserCardSlaves(){$(".market").hide(),$(".slaves").show(),google.charts.load("current",{packages:["corechart","line"]}),google.charts.setOnLoadCallback(function(){let e=new google.visualization.DataTable;e.addColumn("number","цена"),e.addColumn("number","количество"),e.addRows(Card.stat);new google.visualization.LineChart(document.getElementById("slavechart")).draw(e,{legend:"none",hAxis:{gridlines:{},title:"Цена"},vAxis:{gridlines:{},title:"Количество"},backgroundColor:"#fff",colors:["#000"],interpolateNulls:!0,lineWidth:1,title:"",colorAxis:{colors:["#000","#000"]}})}),$("#userCardBalance").text(Card.balance.toLocaleString()),$("#userCardProfitText").text("+"+Card.profit_per_hour_now.toLocaleString()+"/чаc"),$("#userCardRate").text(Card.slaves_count>=1e3&&0==Card.owner_id?"Боярин":"Раб"),$("#userCardPosition").text(parseInt(Card.position)+" место в топе"),$("#userCardPrice").text(Card.price.toLocaleString()),$("#userCardProfitCard").text(Card.profit_per_hour.toLocaleString()+"/чаc"),Card.isOnMarket?($("#sellSlave").hide(),$("#cancelSellSlave").show()):($("#sellSlave").show(),$("#cancelSellSlave").hide())}function btnBuy(){let e=$(".buy-btn");isFriends&&"profile"!==currentPage?bridge.send("VKWebAppCallAPIMethod",{method:"friends.areFriends",request_id:"areFriends",params:{user_ids:e.data("id"),need_sign:1,v:"5.130",access_token:User.access_token}}):doBuy()}function doBuy(e=""){let t,s,a,n="profile"===currentPage;n?(t=$("#slaveUpgrade"),s=$("#userCardPrice"),a=s.text()):(t=$(".buy-btn"),a=t.text());let i="buy"+t.data("id"),r="market";isFriends?r="friends":isExchange&&(r="exchange"),n&&(r="slaves"),$.when(n?s.text("Улучшаем"):t.text("Покупка")).then(function(){$.when(generateHash(i)).then(function(i){n?s.text(a):t.text(a),apiCall("users.buySlave",{pow:i.pow,pow_hash:i.pow_hash,user_id:t.data("id"),section:r,friend_sign:e},function(){updateBalance(isExchange&&!n?User.balance-Card.priceExchange:User.balance-Card.price),userCardClose(),n||$(".slave"+t.data("id")).fadeOut(FADE_SPEED)})})})}function btnSellYourSlaves(){$(".profile-btn").click(),window.scrollTo(0,window.screen.availHeight/2)}function btnSellSlave(){let e=parseInt($("#sellPrice").val()),t=$("#sellSlave"),s=t.text(),a="sell"+Card.user_id+e;$.when(t.text("Продажа")).then(function(){$.when(generateHash(a)).then(function(a){t.text(s),apiCall("users.sell",{pow:a.pow,pow_hash:a.pow_hash,user_id:Card.user_id,price:e},function(){userCardClose(),loadProfile()})})})}function btnCancelSellSlave(){let e=$("#sellSlave"),t=e.text(),s="cancelSell"+Card.user_id;$.when(e.text("Отменяем")).then(function(){$.when(generateHash(s)).then(function(s){e.text(t),apiCall("users.cancelSell",{pow:s.pow,pow_hash:s.pow_hash,user_id:Card.user_id},function(){userCardClose(),loadProfile()})})})}function btnMarketUpdate(){let e=$("#marketUpdate"),t=e.text();$.when(e.text("Обновление списка")).then(function(){$.when(generateHash("refreshRandom")).then(function(s){e.text(t),apiCall("market.refreshRandom",{pow:s.pow,pow_hash:s.pow_hash},function(){updateBalance(User.balance-20),loadMarket()})})})}function btnShieldActivate(){let e=$("#btnShieldActivate");$.when(e.text("Активируем")).then(function(){$.when(generateHash("activateShield")).then(function(t){e.text("Активировать ("+User.shieldCount+")"),apiCall("users.shieldActivate",{pow:t.pow,pow_hash:t.pow_hash},function(t){t.link?window.open(t.link,"_blank"):(User.shieldCount--,User.shieldCount<0&&(User.shieldCount=0),User.shieldTo=t.shieldTo,e.text("Активировать ("+User.shieldCount+")"),$("#shieldTitle").text("Щит (активен):"),$("#shieldTimer").text(t.shield_to))})})})}function openVK(e){e>0?window.open("https://vk.com/id"+e):window.open("https://vk.com/club"+e)}function formatTime(e){return e.split(/\s/)[1]}function btnGetBonus(){Popup.show("Бонус будет доступен в следующем обновлении",!1)}function findUsers(e,t){return Object.values(e).filter(function(e){if(-1!=(e.fullname+"").indexOf(t))return e})}bridge.send("VKWebAppInit"),$(document).ready(function(){iPhoneDesignFixes(),Ref=window.location.hash.substring(1),bridge.send("VKWebAppSetLocation",{location:""}),queryParams=new URL(document.location).searchParams.toString(),bridge.send("VKWebAppGetUserInfo"),bridge.send("VKWebAppGetAuthToken",{app_id:APP_ID,scope:"friends"}),$("#buyOut").click(btnBuyOut),$("#refresh_page").click(btnRefresh),$(".buyDonate").click(getDonateLink),$(".shareBtn").click(btnShare),$(".inviteLink").click(onInviteClick),$("#topSlaves").click(btnTopSlaves),$("#topMasters").click(btnTopMasters),$(".statBtn").click(btnStatPosition),$("#marketCategory").click(btnMarket),$("#exchangeCategory").click(btnExchange),$("#friendsCategory").click(btnFriends),$(".master-btn").click(btnBuyMaster),$(".buy-btn").click(btnBuy),$("#slaveUpgrade").click(btnBuy),$("#sellYourSlaves").click(btnSellYourSlaves),$("#marketUpdate").click(btnMarketUpdate),$("#sellSlave").click(btnSellSlave),$("#cancelSellSlave").click(btnCancelSellSlave),$("#btnShieldActivate").click(btnShieldActivate),$("#btnGetBonus").click(btnGetBonus),$(".menu-button").on("click",function(){btnChangeMenu($(this))})}),bridge.subscribe(function(e){let t;switch(console.log(e),e.detail.data&&(t=e.detail.data),e.detail.type){case"VKWebAppGetUserInfoResult":vk_updateUserInfo(t);break;case"VKWebAppAccessTokenReceived":User.access_token=t.access_token,loadProfile();break;case"VKWebAppCallAPIMethodFailed":case"VKWebAppAccessTokenFailed":Popup.show("Не удалось получить доступ к методам ВК",!0);break;case"VKWebAppCallAPIMethodResult":switch(t.request_id){case"slaves":vk_requestSlaves(t);break;case"top":case"market":vk_requestTopMarket(t);break;case"friends":vk_requestFriends(t);break;case"usercard":vk_requestUsercard(t);break;case"areFriends":vk_requestAreFriends(t)}}});